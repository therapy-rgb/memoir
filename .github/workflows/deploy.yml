name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch: # allow manual trigger from GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Racket
        uses: Bogdanp/setup-racket@0094a9d8bd157633293a2210f373bb542687fa6d # v1.11
        with:
          architecture: x64
          distribution: full
          version: stable

      - name: Cache Racket packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/share/racket
          key: racket-pkgs-${{ runner.os }}-${{ hashFiles('pollen.rkt') }}
          restore-keys: racket-pkgs-${{ runner.os }}-

      - name: Install Pollen
        run: raco pkg install --auto --skip-installed pollen

      - name: Render site
        run: raco pollen render

      - name: Prepare deploy directory
        run: |
          mkdir -p _deploy
          cp *.html _deploy/
          cp styles.css _deploy/
          cp favicon.svg _deploy/
          [ -d fonts ] && cp -r fonts/ _deploy/fonts/ || true
          cp -r images/ _deploy/images/
          echo "methodology.pub" > _deploy/CNAME

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@e9c66a37f080288a11235e32cbe2dc5fb3a679cc # v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_deploy
          keep_files: true
